<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Checkout — ANAA ENTERPRISES</title>
  <meta name="description" content="Pay online via UPI or Cash on Delivery for ANAA ENTERPRISES."/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        fontFamily: { sans: ['Inter','system-ui','sans-serif'] },
        extend: {
          colors: { brand: { 500:'#1897f2',600:'#0f78c6',700:'#0d63a5' } },
          boxShadow: { soft:'0 10px 25px rgba(0,0,0,0.08)' }
        }
      }
    }
  </script>
  <!-- tiny QR generator -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- Header -->
  <header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-gray-200">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 flex h-16 items-center justify-between">
      <a href="index.html" class="flex items-center gap-2">
        <div class="h-10 w-10 rounded-2xl bg-brand-600 text-white grid place-content-center font-extrabold">A</div>
        <div class="leading-tight">
          <div class="text-lg font-extrabold tracking-tight">ANAA ENTERPRISES</div>
          <div class="text-xs text-gray-500">Checkout</div>
        </div>
      </a>
      <nav class="hidden md:flex items-center gap-6 text-sm font-semibold">
        <a href="cart.html" class="hover:text-brand-700">Cart</a>
        <a href="products.html" class="hover:text-brand-700">Products</a>
      </nav>
    </div>
  </header>

  <!-- Main -->
  <main class="py-12">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 grid lg:grid-cols-3 gap-6">
      <!-- Payment -->
      <section class="lg:col-span-2">
        <h1 class="text-3xl font-extrabold">Complete your order</h1>
        <p class="mt-1 text-sm text-gray-600">Pay online with UPI or choose Cash on Delivery. If you pay by UPI, enter the transaction ID so we can match it.</p>

        <div class="mt-6 grid md:grid-cols-2 gap-6">
          <!-- UPI Block -->
          <div class="rounded-2xl border bg-white p-6">
            <div class="text-lg font-extrabold">UPI payment</div>
            <div class="mt-1 text-sm text-gray-600">Scan the QR or tap “Pay in UPI app.”</div>

            <div class="mt-4 grid gap-3">
              <div class="text-sm">
                Payee: <span id="payeeName" class="font-semibold"></span><br/>
                UPI ID: <span id="upiId" class="font-mono"></span>
                <button id="copyUpi" class="ml-2 text-xs rounded border px-2 py-1">Copy</button>
              </div>

              <div class="rounded-xl border p-4 grid place-items-center">
                <div id="qrcode"></div>
              </div>

              <div class="grid sm:grid-cols-2 gap-2">
                <a id="upiIntent" class="rounded-xl bg-brand-600 text-white text-center px-4 py-2 text-sm font-semibold hover:bg-brand-700">Pay in UPI app</a>
                <button id="saveQR" class="rounded-xl border px-4 py-2 text-sm font-semibold hover:bg-gray-50">Download QR</button>
              </div>

              <div class="mt-2 text-sm">
                Amount: <span id="due" class="font-extrabold"></span>
              </div>

              <label class="mt-2 text-sm">Transaction/UTR ID (after payment)
                <input id="utr" class="mt-1 w-full rounded-xl border px-3 py-2 text-sm" placeholder="12-digit UTR or reference number">
              </label>
            </div>
          </div>

          <!-- COD Block -->
          <div class="rounded-2xl border bg-white p-6">
            <div class="text-lg font-extrabold">Cash on Delivery</div>
            <p class="mt-1 text-sm text-gray-600">Pay when the order arrives. Delivery charge may apply.</p>
            <button id="placeCOD" class="mt-3 w-full rounded-xl border px-4 py-2 text-sm font-semibold hover:bg-gray-50">Place COD Order</button>
          </div>
        </div>

        <!-- Address -->
        <div class="mt-6 rounded-2xl border bg-white p-6">
          <div class="text-lg font-extrabold">Shipping details</div>
          <form id="orderForm" class="mt-3 grid md:grid-cols-2 gap-3">
            <input id="name" class="rounded-xl border px-3 py-2 text-sm" placeholder="Full name" required>
            <input id="phone" class="rounded-xl border px-3 py-2 text-sm" placeholder="Phone" required>
            <input id="address" class="md:col-span-2 rounded-xl border px-3 py-2 text-sm" placeholder="Address" required>
            <input id="pincode" class="rounded-xl border px-3 py-2 text-sm" placeholder="Pincode" required>
            <input id="city" class="rounded-xl border px-3 py-2 text-sm" placeholder="City" required>
            <textarea id="notes" class="md:col-span-2 rounded-xl border px-3 py-2 text-sm" placeholder="Notes for delivery (optional)"></textarea>
            <div class="md:col-span-2 flex gap-2">
              <button id="confirmUPI" class="flex-1 rounded-xl bg-brand-600 text-white px-4 py-3 text-sm font-semibold hover:bg-brand-700">Confirm UPI Payment</button>
            </div>
          </form>
          <div id="done" class="mt-3 text-sm text-green-700 hidden"></div>
        </div>
      </section>

      <!-- Summary -->
      <aside class="lg:col-span-1">
        <div class="rounded-2xl border bg-white p-6">
          <div class="text-lg font-extrabold">Order summary</div>
          <div id="items" class="mt-3 space-y-2 text-sm"></div>
          <div class="mt-3 flex justify-between text-sm"><span>Subtotal</span><span id="subTotal">₹0</span></div>
          <div class="mt-1 flex justify-between text-sm"><span>Delivery</span><span id="deliveryFee">₹0</span></div>
          <div class="mt-2 flex justify-between font-extrabold"><span>Total</span><span id="grandTotal">₹0</span></div>
        </div>
      </aside>
    </div>
  </main>

  <footer class="border-t bg-white mt-12">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-6 text-sm text-gray-600 flex flex-col sm:flex-row justify-between items-center">
      <div>© <span id="year"></span> ANAA ENTERPRISES</div>
      <div class="flex gap-4">
        <a href="#" class="hover:text-brand-700">Return policy</a>
        <a href="#" class="hover:text-brand-700">Shipping</a>
        <a href="#" class="hover:text-brand-700">Privacy</a>
      </div>
    </div>
  </footer>

  <!-- If you added firebase-config earlier, it will be available as window.db/window.auth -->
  <script>
    // ==== CONFIGURE YOUR UPI DETAILS HERE ====
    const UPI = {
      id: 'anaastore@oksbi',          // <-- your UPI ID
      name: 'ANAA ENTERPRISES',       // Payee name
      note: 'Online order ANAA',      // Payment note
      currency: 'INR'
    };

    const CART_KEY = 'anaa_cart';
    const fmt = n => '₹' + Number(n||0).toLocaleString('en-IN');
    const year = document.getElementById('year'); year.textContent = new Date().getFullYear();

    // Load cart
    function getCart(){ try { return JSON.parse(localStorage.getItem(CART_KEY)) || []; } catch { return []; } }
    function calcTotals(){
      const c = getCart();
      const sub = c.reduce((s,i)=> s + (i.price*i.qty), 0);
      const del = sub >= 999 || sub === 0 ? 0 : 49;
      return { sub, del, total: sub + del };
    }

    // Render summary
    function renderSummary(){
      const itemsBox = document.getElementById('items');
      const { sub, del, total } = calcTotals();
      const c = getCart();
      if(!c.length){
        itemsBox.innerHTML = '<div class="rounded-xl border p-3 text-gray-600">Your cart is empty. <a class="underline" href="products.html">Add items</a></div>';
      } else {
        itemsBox.innerHTML = c.map(i=>`
          <div class="flex justify-between">
            <span>${i.title} × ${i.qty}</span><span>${fmt(i.price*i.qty)}</span>
          </div>
        `).join('');
      }
      document.getElementById('subTotal').textContent = fmt(sub);
      document.getElementById('deliveryFee').textContent = fmt(del);
      document.getElementById('grandTotal').textContent = fmt(total);
      return total;
    }

    // Build UPI intent and QR
    function upiLink(amount){
      // upi://pay?pa=<VPA>&pn=<name>&am=<amount>&tn=<note>&cu=INR
      const p = new URLSearchParams({
        pa: UPI.id,
        pn: UPI.name,
        am: String(amount),
        tn: UPI.note,
        cu: UPI.currency
      }).toString();
      return 'upi://pay?' + p;
    }

    function buildQR(text){
      const box = document.getElementById('qrcode');
      box.innerHTML = '';
      // eslint-disable-next-line no-new
      new QRCode(box, { text, width: 200, height: 200 });
    }

    function downloadQR(){
      const img = document.querySelector('#qrcode img');
      const canvas = document.querySelector('#qrcode canvas');
      const src = img ? img.src : canvas.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = src;
      a.download = 'ANAA_UPI_QR.png';
      a.click();
    }

    function fillUPI(amount){
      document.getElementById('payeeName').textContent = UPI.name;
      document.getElementById('upiId').textContent = UPI.id;
      document.getElementById('due').textContent = fmt(amount);
      const link = upiLink(amount);
      document.getElementById('upiIntent').href = link;
      buildQR(link);
    }

    // Order submitters

async function saveOrder(payload){
  // Local fallback so admin can always see orders
  try {
    const key = 'anaa_orders';
    const arr = JSON.parse(localStorage.getItem(key) || '[]');
    arr.unshift(payload);
    localStorage.setItem(key, JSON.stringify(arr));
  } catch(e){ console.warn('Local order save failed', e); }

  // If Firebase exists, also save to Firestore
  if (window.db) {
    try {
      const { addDoc, collection, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js');
      await addDoc(collection(window.db,'orders'), { ...payload, createdAt: serverTimestamp() });
    } catch(e){
      console.warn('Failed to save order to Firestore:', e);
    }
  }
}



    function collectCustomer(){
      return {
        name: document.getElementById('name').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        address: document.getElementById('address').value.trim(),
        pincode: document.getElementById('pincode').value.trim(),
        city: document.getElementById('city').value.trim(),
        notes: document.getElementById('notes').value.trim()
      };
    }

    function validateCustomer(c){
      if(!c.name || !c.phone || !c.address || !c.pincode || !c.city) return false;
      return true;
    }

    // Handlers
    document.getElementById('copyUpi').addEventListener('click', ()=>{
      navigator.clipboard.writeText(UPI.id);
      alert('UPI ID copied: ' + UPI.id);
    });
    document.getElementById('saveQR').addEventListener('click', downloadQR);

    document.getElementById('placeCOD').addEventListener('click', async ()=>{
      const amount = renderSummary();
      const customer = collectCustomer();
      if(!validateCustomer(customer)) return alert('Fill shipping details first.');
      const orderId = 'ANAA' + Math.floor(100000 + Math.random()*900000);
      const cart = getCart();
      await saveOrder({
        orderId, amount, paymentMode:'COD', paymentStatus:'pending',
        items: cart, customer
      });
      localStorage.setItem(CART_KEY, '[]');
      document.getElementById('done').classList.remove('hidden');
      document.getElementById('done').textContent = 'COD order placed. Order ID: ' + orderId + '. We will confirm by call/WhatsApp.';
      alert('COD order placed. Order ID: ' + orderId);
    });

    document.getElementById('confirmUPI').addEventListener('click', async (e)=>{
      e.preventDefault();
      const amount = renderSummary();
      const utr = document.getElementById('utr').value.trim();
      const customer = collectCustomer();
      if(!validateCustomer(customer)) return alert('Fill shipping details first.');
      if(!utr) return alert('Enter the UPI transaction/UTR ID after you pay.');
      const orderId = 'ANAA' + Math.floor(100000 + Math.random()*900000);
      const cart = getCart();
      await saveOrder({
        orderId, amount, paymentMode:'UPI', paymentStatus:'pending',
        utr, upiId: UPI.id, items: cart, customer
      });
      localStorage.setItem(CART_KEY, '[]');
      document.getElementById('done').classList.remove('hidden');
      document.getElementById('done').textContent = 'UPI payment noted. Order ID: ' + orderId + '. We will verify and confirm.';
      alert('Payment noted. Order ID: ' + orderId + '. We will verify and confirm.');
    });

    // Boot
    const total = renderSummary();
    fillUPI(total);
  </script>
</body>
</html>
